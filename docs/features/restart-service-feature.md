# 服务重启功能使用说明

## 功能概述

在SSH隧道应用的配置管理页面(`/view/app/config`)中新增了"重启服务"按钮，允许用户在更新配置后快速重启服务以应用新的配置。

## 功能特性

### 1. 智能运行模式检测
- **服务模式**: 自动检测程序是否作为系统服务运行
- **直接运行模式**: 检测程序是否直接启动运行
- **自适应处理**: 根据不同运行模式采用最适合的重启策略

### 2. 用户界面
- **位置**: 配置页面右上角的操作按钮组中
- **样式**: 红色轮廓按钮，带有旋转箭头图标
- **提示**: 鼠标悬停显示"重启服务"提示

### 3. 安全确认
- 点击按钮时会弹出确认对话框
- 明确提示重启服务的影响：
  - 重新加载配置文件
  - 重新建立SSH隧道连接
  - 如果是服务模式，将重启整个服务
  - 预计耗时几秒钟

## 重启策略

### 服务模式重启
当检测到程序作为系统服务运行时，支持多操作系统平台：

#### Windows 平台
1. **主要方法**: 使用 `sc` 命令控制服务
   - `sc stop SSHTunnelService` - 停止服务
   - `sc start SSHTunnelService` - 启动服务
2. **备用方法**: 使用 `net` 命令
   - `net stop SSHTunnelService` - 停止服务
   - `net start SSHTunnelService` - 启动服务
3. **容错机制**: 如果主要方法失败，自动尝试备用方法

#### macOS 平台
1. **主要方法**: 使用 `launchctl` 命令控制服务
   - `launchctl stop com.idefav.ssh-tunnel` - 停止服务
   - `launchctl start com.idefav.ssh-tunnel` - 启动服务
2. **备用方法**: 卸载并重新加载服务配置
   - `launchctl unload /Library/LaunchDaemons/com.idefav.ssh-tunnel.plist`
   - `launchctl load /Library/LaunchDaemons/com.idefav.ssh-tunnel.plist`
3. **服务配置**: 需要正确配置 plist 文件

#### Linux 平台
1. **systemd 系统** (现代Linux发行版):
   - `systemctl restart ssh-tunnel` - 直接重启服务
   - 回退方案: `systemctl stop` + `systemctl start`
2. **SysV init 系统** (传统Linux系统):
   - `service ssh-tunnel restart` - 直接重启服务
   - 回退方案: `service ssh-tunnel stop` + `service ssh-tunnel start`
3. **自动检测**: 程序会自动检测可用的服务管理器

#### 通用平台支持
- 对于其他不常见的操作系统，程序会优雅退出
- 依赖外部监控程序重新启动服务

### 直接运行模式重启  
当检测到程序直接运行时：
1. **配置热重载**: 重新读取配置文件并更新应用配置
2. **连接重建**: 关闭现有SSH连接，触发自动重连机制
3. **无需进程重启**: 避免了进程重启的复杂性和风险

## 技术优势

### 1. 配置热重载
- 利用程序内置的fsnotify配置监听机制
- 无需重启进程即可应用大部分配置更改
- 更快速、更安全的配置更新

### 2. SSH连接管理
- 优雅关闭现有SSH连接
- 自动触发重连机制
- 保持服务的持续可用性

### 3. 智能模式检测
- 自动识别运行环境
- 采用最适合的重启策略
- 减少用户操作复杂度

## 使用流程

### 通用流程
1. 用户在配置页面点击"重启服务"按钮
2. 系统显示确认对话框说明重启影响
3. 确认后按钮变为加载状态
4. 后端检测运行模式并执行相应的重启策略
5. 前端显示处理进度，自动恢复按钮状态

### 服务模式流程
1. 检测到服务模式
2. 使用系统命令停止服务
3. 等待服务停止
4. 重新启动服务
5. 程序完全重启

### 直接运行模式流程
1. 检测到直接运行模式
2. 重新加载配置文件
3. 关闭SSH连接触发重连
4. 程序继续运行，配置生效

## 适用场景

1. **配置更新后**: 修改服务器配置、端口设置等需要生效的配置
2. **连接异常时**: SSH连接出现问题需要重新建立连接
3. **定期维护**: 定期刷新服务状态和配置
4. **开发调试**: 开发过程中快速应用配置更改

## 错误处理

- 配置重载失败时会记录详细日志
- 服务重启失败时提供明确的错误信息
- 前端提供用户友好的错误提示
- 按钮状态自动恢复，允许重试

## 技术实现

### API接口
- **路径**: `POST /admin/service/restart`
- **功能**: 智能处理服务重启请求
- **响应**: JSON格式的处理状态信息

### 核心函数
- `checkIfRunningAsService()`: 检测运行模式
- `triggerConfigReload()`: 触发配置重载
- `restartAsService()`: 服务模式重启
- `restartWindowsService()`: Windows服务重启
- `restartMacOSService()`: macOS服务重启
- `restartLinuxService()`: Linux服务重启

### 前端交互
- 使用Bootstrap模态框和Toast组件提供用户反馈
- JavaScript实现异步请求和状态管理
- 自动倒计时和状态恢复

## 注意事项

1. **配置文件**: 确保配置文件路径正确且具有读取权限
2. **服务权限**: 服务模式重启需要适当的系统权限
3. **网络连接**: SSH连接重建过程中可能出现短暂中断
4. **日志监控**: 建议检查应用日志以确认重启结果

## 日志输出示例

### 直接运行模式
```
收到服务重启请求
开始执行服务重启...
运行模式检测: 服务模式=false
检测到直接运行模式，尝试重新加载配置...
正在关闭SSH连接以触发重连...
配置文件重新加载成功
应用配置更新完成
配置重载完成，SSH连接将自动重新建立
```

### 服务模式
```
收到服务重启请求
开始执行服务重启...
运行模式检测: 服务模式=true
使用服务模式重启...
正在重启Windows服务...
服务重启成功
服务重启处理完成，退出程序...
```

这个改进的重启功能现在能够智能地处理不同的运行环境，为直接运行模式提供了更安全可靠的配置重载机制，避免了进程重启带来的问题。
